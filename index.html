<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UNO Online</title>
<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  text-align:center;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
button{
  padding:10px 15px;
  margin:5px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}
button:hover{ background:#1d4ed8; }
input{
  padding:10px;
  border-radius:8px;
  border:none;
}
.card{
  display:inline-block;
  padding:12px;
  margin:4px;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
.red{background:#e53935;}
.blue{background:#1e88e5;}
.green{background:#43a047;}
.yellow{background:#fdd835;color:black;}
#game{display:none;}
#room{display:none;}
#lobby{display:none;}
</style>
</head>
<body>

<div class="container">

<div id="login">
  <h2>UNO Online</h2>
  <input id="nameInput" placeholder="Nama kamu">
  <br><br>
  <button onclick="login()">Masuk</button>
</div>

<div id="lobby">
  <h3>Lobby</h3>
  <button onclick="createRoom()">Create Room</button>
  <br>
  <input id="roomInput" placeholder="Kode Room">
  <button onclick="joinRoomFromInput()">Join Room</button>
  <br><br>
  <h4>Quick Match</h4>
  <button onclick="quickCasual()">Quick Casual</button>
  <button onclick="quickRanked1v1()">Quick Ranked 1v1</button>
  <div id="rankInfo"></div>
</div>

<div id="room">
  <h3 id="roomTitle"></h3>
  <div id="players"></div>
  <button id="startBtn" onclick="startGame()">Start Game</button>
</div>

<div id="game">
  <h3 id="modeTitle"></h3>
  <div id="discard"></div>
  <div id="hand"></div>
</div>

<div id="leaderboard"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, update, push, onValue, get, remove }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyBvd1DHwW8ObHX2RpQHVAC5ToiKWH-z0Cg",
  authDomain: "uno-online-9ff2f.firebaseapp.com",
  projectId: "uno-online-9ff2f",
  storageBucket: "uno-online-9ff2f.firebasestorage.app",
  messagingSenderId: "285267848462",
  appId: "1:285267848462:web:da24cfb8d4ff04441b7b5f"
};


const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let profile = {
  id:"p_"+Math.random().toString(36).substring(2,9),
  name:"",
  ranks:{ "1v1":1000 }
};

let roomId="";
let isHost=false;

window.login = function(){
  const name=document.getElementById("nameInput").value.trim();
  if(!name) return alert("Masukkan nama");
  profile.name=name;
  document.getElementById("login").style.display="none";
  document.getElementById("lobby").style.display="block";
  loadRank();
};

function loadRank(){
  onValue(ref(db,"players/"+profile.id),(snap)=>{
    if(snap.exists()){
      profile.ranks = snap.val().ranks || profile.ranks;
    }
    document.getElementById("rankInfo").innerHTML=
      "Rank 1v1: "+profile.ranks["1v1"];
  });
}

function generateRoomCode(){
  return "UNO-"+Math.random().toString(36).substring(2,6).toUpperCase();
}

window.createRoom=async function(){
  const code=generateRoomCode();
  roomId=code;
  isHost=true;

  await set(ref(db,"rooms/"+code),{
    mode:"casual",
    host:profile.id,
    started:false,
    turnIndex:0,
    players:{}
  });

  joinRoom(code);
};

window.joinRoomFromInput=function(){
  const code=document.getElementById("roomInput").value.trim();
  if(!code) return alert("Masukkan kode");
  joinRoom(code);
};

async function joinRoom(code){
  roomId=code;

  await set(ref(db,"rooms/"+code+"/players/"+profile.id),{
    name:profile.name,
    hand:[]
  });

  document.getElementById("lobby").style.display="none";
  document.getElementById("room").style.display="block";
  document.getElementById("roomTitle").innerText="Room: "+code;

  listenRoom();
}

function listenRoom(){
  onValue(ref(db,"rooms/"+roomId),(snap)=>{
    const data=snap.val();
    if(!data) return;

    renderPlayers(data.players);

    if(data.started){
      document.getElementById("room").style.display="none";
      document.getElementById("game").style.display="block";
      document.getElementById("modeTitle").innerText=
        data.mode==="ranked"?"Ranked 1v1":"Casual";
      updateGame(data);
    }

    if(data.host!==profile.id){
      document.getElementById("startBtn").style.display="none";
    }
  });
}

window.startGame=async function(){
  const snap=await get(ref(db,"rooms/"+roomId+"/players"));
  const players=snap.val();
  let deck=generateDeck();
  let updated={};

  Object.keys(players).forEach(id=>{
    updated[id]={...players[id],hand:deck.splice(0,7)};
  });

  await update(ref(db,"rooms/"+roomId),{
    started:true,
    discard:deck.pop(),
    players:updated
  });
};

function updateGame(data){
  const ids=Object.keys(data.players);
  const me=data.players[profile.id];

  document.getElementById("discard").innerHTML=
    "<div class='card "+data.discard.color+"'>"+data.discard.value+"</div>";

  const handDiv=document.getElementById("hand");
  handDiv.innerHTML="";

  me.hand.forEach((card,i)=>{
    const div=document.createElement("div");
    div.className="card "+card.color;
    div.innerText=card.value;

    if(ids[data.turnIndex]===profile.id){
      div.onclick=()=>playCard(i);
    }

    handDiv.appendChild(div);
  });
}

async function playCard(index){
  const snap=await get(ref(db,"rooms/"+roomId));
  const data=snap.val();
  const ids=Object.keys(data.players);
  if(ids[data.turnIndex]!==profile.id) return;

  let player=data.players[profile.id];
  let card=player.hand[index];
  player.hand.splice(index,1);

  let next=(data.turnIndex+1)%ids.length;

  await update(ref(db,"rooms/"+roomId),{
    discard:card,
    turnIndex:next,
    ["players/"+profile.id]:player
  });

  if(player.hand.length===0){
    alert(profile.name+" MENANG!");
    if(data.mode==="ranked"){
      profile.ranks["1v1"]+=30;
      await set(ref(db,"players/"+profile.id),{
        name:profile.name,
        ranks:profile.ranks
      });
    }
    await remove(ref(db,"rooms/"+roomId));
    location.reload();
  }
}

window.quickCasual=async function(){
  createRoom();
};

window.quickRanked1v1=async function(){
  const code=generateRoomCode();
  roomId=code;
  isHost=true;

  await set(ref(db,"rooms/"+code),{
    mode:"ranked",
    format:"1v1",
    host:profile.id,
    started:false,
    turnIndex:0,
    players:{}
  });

  joinRoom(code);
};

function generateDeck(){
  const colors=["red","blue","green","yellow"];
  const values=["0","1","2","3","4","5","6","7","8","9"];
  let deck=[];
  for(let c of colors){
    for(let v of values){
      deck.push({color:c,value:v});
    }
  }
  return shuffle(deck);
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function renderPlayers(players){
  const div=document.getElementById("players");
  div.innerHTML="<b>Pemain:</b><br>";
  Object.values(players).forEach(p=>{
    div.innerHTML+=p.name+"<br>";
  });
}

</script>
</body>
</html>

